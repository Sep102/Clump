#! /bin/sh

#-------------------------------------------------------------------------------
# If you want to change any clump program defaults, change them here.

install_location='/usr/local/bin'
default_objdir='../obj'
default_bindir='../bin'
default_compile='gcc -c -Wall -Werror -ansi -O2 $(cfile) -o $(ofile)'
default_link='gcc $(objects) -o $(efile)'

#-------------------------------------------------------------------------------

configure=0
build=0
publish=0
valid=0

if test "$1" = configure; then
	configure=1
	valid=1
fi
if test "$1" = build; then
	configure=1
	build=1
	valid=1
fi
if test "$1" = install; then
	configure=1
	build=1
	publish=1
	valid=1
fi
if test "$1" = publish; then
	publish=1
	valid=1
fi

if test $valid -eq 0; then
	echo "Usage:  run [install | build | publish]"
	echo ""
	echo "  run install"
	echo "      This will do everything you need, configuring and building"
	echo "      the clump program and publishing it in $install_location."
	echo ""
	echo "      [Note:  If you want to change where clump is installed, just"
	echo "      change the install_location variable at the top of this \"run\""
	echo "      script.]"
	echo ""
	echo "  run configure"
	echo "      This configures clump based on your operating system."
	echo ""
	echo "  run build"
	echo "      Use this if you just want to recompile clump in your ../bin"
	echo "      directory without publishing it in $install_location."
	echo "      Note:  Once you've built clump this way, from then on you can"
	echo "      use clump to build itself and you no longer need this script."
	echo ""
	echo "  run publish"
	echo "      Publish the already built clump into $install_location."
	echo ""
fi

if test $configure -eq 1; then
	echo "Configuring clump"

	cat >conftest.c <<EOF
#include <getopt.h>
EOF
	gcc -fsyntax-only conftest.c >conftest.out 2>&1

	if test $? -eq 0; then
		use_getopt_h=1
	else
		use_getopt_h=0
	fi

	rm -f conftest.c conftest.out

	cat >config.h <<EOF
/* This file generated by "run configure" */

#define USE_GETOPT_H $use_getopt_h
EOF

	cat >clump.h <<EOF
/* This file generated by "run configure" */

const char *default_objdir = "$default_objdir";
const char *default_bindir = "$default_bindir";

const char *default_compile =
"$default_compile";

const char *default_link =
"$default_link";
EOF

fi

if test $build -eq 1; then
	echo "Building clump"
	if !(test -d ../obj); then mkdir ../obj; fi
	if !(test -d ../bin); then mkdir ../bin; fi
	gcc -c -Wall -Werror -ansi -O2 bufd.c -o ../obj/bufd.o
	gcc -c -Wall -Werror -ansi -O2 dir.c -o ../obj/dir.o
	gcc -c -Wall -Werror -ansi -O2 clump.c -o ../obj/clump.o
	gcc -c -Wall -Werror -ansi -O2 strq.c -o ../obj/strq.o
	gcc ../obj/clump.o ../obj/bufd.o ../obj/dir.o ../obj/strq.o -o ../bin/clump
fi

if test $publish -eq 1; then
	echo "Publishing clump in $install_location"
	cp -p ../bin/clump $install_location
fi
